# 第9章 実践プロジェクト事例

## 9.1 ケーススタディ概要
本章では、ncnnを活用した3つのプロジェクト事例を取り上げ、モデル変換から最適化、アプリ統合までの実践的な流れを紹介する。各ケースでは課題設定、採用モデル、最適化戦略、検証プロセス、成果と学びを整理し、読者が自プロジェクトに適用する際の指針とする。

## 9.2 事例1: スマートフォン向けリアルタイム顔フィルタ
### 課題と要件
SNSアプリでリアルタイムに顔フィルタを適用するため、60fpsに近い推論速度と低消費電力が求められた。端末はAndroidのミッドレンジ機種を想定し、カメラ入力から顔ランドマーク検出、エフェクト適用まで150ms以内で処理する必要があった。
### 実装フロー
- モデル: PyTorchで学習したLightweight Face AlignmentネットワークをONNX経由でncnnに変換。
- 最適化: `ncnnoptimize`とINT8量子化を適用し、CPU負荷を軽減。量子化後の精度差は顔ランドマークの平均誤差0.5px以下。
- アプリ統合: カメラフレームを`Mat::PIXEL_RGBA2BGR`で変換し、Extractorを複数スレッドで再利用。推論結果からエフェクトマスクを生成し、OpenGLで描画。
### 成果と学び
平均レイテンシは約22ms、バッテリー消費は5分間連続使用で5%以下に抑制。Vulkan有効化で高性能端末ではさらに10〜15%の高速化が得られたが、全端末で安定しないため初期リリースではCPUパスを採用。ログ収集により特定端末での精度低下が判明し、後日カスタムキャリブレーションデータを追加した。

## 9.3 事例2: 産業用エッジデバイスでの欠陥検知
### 課題と要件
製造ラインで部品の表面欠陥を検知するため、エッジデバイス（ARM Cortex-A72 + GPUなし）上で高精度な推論を実現する必要があった。照明条件が変動するため、モデルのロバスト性とオンサイトでの再学習パイプラインが求められた。
### 実装フロー
- モデル: ResNetベースのセグメンテーションをU-Netへ置き換え、`onnx2ncnn`で変換。
- 最適化: FP16ストレージと`use_packing_layout`を有効化。畳み込みレイヤーはWinogradを無効化し、省メモリに重視した設定に変更。
- 運用: ncnn推論結果をPLCへ送信し、欠陥が検出された場合はラインを停止。モデル更新はリモートでONNXを送信し、端末側で自動変換スクリプトがncnn形式へ変換。
### 成果と学び
推論時間は1画像あたり65ms、検出精度はリコール97%。エッジ端末でのメモリピークは200MB以内に収まり、24/7稼働でも安定。照明変動に対応するため、定期的にキャリブレーションデータを収集し、モデル再学習→デプロイを月次サイクルで回す運用を確立した。

## 9.4 事例3: 医療画像解析タブレットアプリ
### 課題と要件
病院内でタブレットを用いて超音波画像の診断支援を行うため、Wi-Fiが不安定な環境でもスタンドアロンで動作する推論アプリが必要だった。医療用途のため推論結果のトレーサビリティと検証可能性が重視された。
### 実装フロー
- モデル: TensorFlowで学習したSegmentationモデルをONNX化。`onnx-simplifier`で簡素化したのちncnnへ変換。
- 最適化: INT8量子化は精度要件を満たさなかったためFP32のまま運用。Vulkan対応タブレットではGPU推論を採用し、CPUとの整合性を検証。
- 信頼性: 推論ログをFHIR形式で保存し、医師が後日確認できるように設計。ncnnの結果をDICOMタグに付与して保管。
### 成果と学び
推論時間は平均120ms、医師の評価では精度95%以上を維持。タブレット温度上昇が課題となったため、推論間隔を可変にして連続使用時の発熱を抑えた。医療監査用にカスタムレイヤーのコードレビューとテストログを保管するプロセスを整備した。

## 9.5 共通の成功要因
- 早期のプロファイリングでボトルネックと端末差異を洗い出し、設定チューニングを行った。
- モデル変換・最適化・推論・ログ収集までの自動パイプラインを整備し、更新コストを低減した。
- 端末固有の問題（GPUドライバ、熱暴走、メモリ制限）に対応するため、フォールバックプランを用意した。

## 9.6 本章のまとめ
実践事例を通じて、ncnnを使ったスマートフォン、産業エッジ、医療アプリの成功パターンを紹介した。多様な要件に対し、モデル選定、最適化設定、運用設計が柔軟に組み合わされていることがわかる。次章ではトラブルシューティングとベストプラクティスをまとめ、開発・運用時に役立つチェックリストを提示する。
